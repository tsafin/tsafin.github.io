<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Какая-такая Data? или Еще раз про MapReduce • Timur Safin - Making No Sense</title>
    <meta name="description" content="
   Если Вы последние 10 лет провели на удаленном острове, без интернета и в отрыве от цивилизации, то специально для Вас мы попытаемся еще раз рассказать про концепцию MapReduce. Введение будет небольшим, в объеме достаточном, для реализации концепции MapReduce в среде InterSystems Caché. Если же Вы не сильно далеко удалялись последние 10 лет, то сразу переходите ко 2ой части, где мы создаем основы инфраструктуры.


">
    <meta name="keywords" content="">
    
    	<!-- Twitter Cards -->
	<meta name="twitter:title" content="Какая-такая Data? или Еще раз про MapReduce">
	<meta name="twitter:description" content="
   Если Вы последние 10 лет провели на удаленном острове, без интернета и в отрыве от цивилизации, то специально для Вас мы попытаемся еще раз рассказать про концепцию MapReduce. Введение будет небольшим, в объеме достаточном, для реализации концепции MapReduce в среде InterSystems Caché. Если же Вы не сильно далеко удалялись последние 10 лет, то сразу переходите ко 2ой части, где мы создаем основы инфраструктуры.


">
	<meta name="twitter:site" content="@tsafin">
	<meta name="twitter:creator" content="@tsafin">
	
	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:image" content="http://tsafin.net/images/landscapes/feature7.jpg">
	
	<!-- Open Graph -->
	<meta property="og:locale" content="en">
	<meta property="og:type" content="article">
	<meta property="og:title" content="Какая-такая Data? или Еще раз про MapReduce">
	<meta property="og:description" content="
   Если Вы последние 10 лет провели на удаленном острове, без интернета и в отрыве от цивилизации, то специально для Вас мы попытаемся еще раз рассказать про концепцию MapReduce. Введение будет небольшим, в объеме достаточном, для реализации концепции MapReduce в среде InterSystems Caché. Если же Вы не сильно далеко удалялись последние 10 лет, то сразу переходите ко 2ой части, где мы создаем основы инфраструктуры.


">
	<meta property="og:url" content="http://tsafin.net/blog/mapreduce/mapreduce-russian-part-i/">
	<meta property="og:site_name" content="Timur Safin - Making No Sense">

    <link rel="canonical" href="http://tsafin.net/blog/mapreduce/mapreduce-russian-part-i/">

    <link href="http://tsafin.net/atom.xml" type="application/atom+xml" rel="alternate" title="Timur Safin - Making No Sense Atom Feed">
    <link href="http://tsafin.net/sitemap.xml" type="application/xml" rel="sitemap" title="Sitemap">

    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="cleartype" content="on">

    <link rel="stylesheet" href="http://tsafin.net/css/main.css">
    <!-- HTML5 Shiv and Media Query Support for IE -->
    <!--[if lt IE 9]>
      <script src="http://tsafin.net/js/vendor/html5shiv.min.js"></script>
      <script src="http://tsafin.net/js/vendor/respond.min.js"></script>
    <![endif]-->
  </head>

  <body id="js-body">
    <!--[if lt IE 9]><div class="upgrade notice-warning"><strong>Your browser is quite old!</strong> Why not <a href="http://whatbrowser.org/">upgrade to a newer one</a> to better enjoy this site?</div><![endif]-->

    <header id="masthead">
  <div class="inner-wrap">
    <a href="http://tsafin.net/" class="site-title">Timur Safin - Making No Sense</a>
    <nav role="navigation" class="menu top-menu">
        <ul class="menu-item">
	<li class="home"><a href="/">Timur Safin - Making No Sense</a></li>
	 
      
      <li><a href="http://tsafin.net/blog/" >Articles</a></li>
    
      
      <li><a href="http://tsafin.net/projects/" >Projects</a></li>
    
      
      <li><a href="http://tsafin.net/resume/" >About</a></li>
    
</ul>
    </nav>
  </div><!-- /.inner-wrap -->
</header><!-- /.masthead -->
    <nav role="navigation" id="js-menu" class="sliding-menu-content">
  <h5>Timur Safin - Making No Sense <span>Table of Contents</span></h5>
  <ul class="menu-item">
    <li>
      <a href="http://tsafin.net/blog/">
        
        <div class="title">Articles</div>
        <p class="excerpt">Blog posts and random rumblings...</p>
      </a>
    </li><li>
      <a href="http://tsafin.net/projects/">
        
        <div class="title">Projects</div>
        <p class="excerpt">Open-source projects</p>
      </a>
    </li><li>
      <a href="http://tsafin.net/resume/">
        
        <div class="title">About</div>
        <p class="excerpt">Resume and such...</p>
      </a>
    </li>
  </ul>
</nav>
<button type="button" id="js-menu-trigger" class="sliding-menu-button lines-button x2" role="button" aria-label="Toggle Navigation">
  <span class="nav-lines"></span>
</button>

<div id="js-menu-screen" class="menu-screen"></div>


    <div id="page-wrapper">
      <div id="main" role="main">
	<article class="wrap" itemscope itemtype="http://schema.org/Article">
		
		<div class="page-feature">
			<div class="page-image">
				<img src="http://tsafin.net/images/landscapes/feature7.jpg" class="page-feature-image" alt="Какая-такая Data? или Еще раз про MapReduce" itemprop="image">
				
			</div><!-- /.page-image -->
		</div><!-- /.page-feature -->
		
		
<nav class="breadcrumbs">
    <span itemscope itemtype="http://data-vocabulary.org/Breadcrumb">
      <a href="http://tsafin.net" itemprop="url">
        <span itemprop="title">Home</span>
    </a> ›
    <span itemscope itemtype="http://data-vocabulary.org/Breadcrumb">
      <a href="http://tsafin.net/blog/" itemprop="url">
        <span itemprop="title">Blog</span>
    </a>
    </span>
</nav>
<!-- /.breadcrumbs -->


<div class="breadcrumbs sm">
    <a href="https://habrahabr.ru/company/intersystems/blog/310180/" itemprop="url">
        https://habrahabr.ru/company/intersystems/blog/310180/&nbsp;<span class="glyphicon glyphicon-share" aria-hidden="true"></span>
    </a>
</div>

		<div class="page-title">
			<h1>Какая-такая Data? или Еще раз про MapReduce</h1>
		</div>
		<div class="inner-wrap">
			<div id="content" class="page-content" itemprop="articleBody">
				<blockquote>
  <p><em><a href="https://habrahabr.ru/company/intersystems/blog/310180/"><img src="https://habrastorage.org/getpro/habr/post_images/fa7/7e6/27c/fa77e627c184bec95f61df62ccca0b54.jpg" align="left" width="288" height="240" alt="Big Fish Small Fry by John Pollack" /></a> Если Вы последние 10 лет провели на удаленном острове, без интернета и в отрыве от цивилизации, то специально для Вас мы попытаемся еще раз рассказать про концепцию MapReduce. Введение будет небольшим, в объеме достаточном, для реализации концепции MapReduce в среде InterSystems Caché. Если же Вы не сильно далеко удалялись последние 10 лет, то сразу переходите ко 2ой части, где мы создаем основы инфраструктуры.<br /><br /><br /></em></p>
</blockquote>

<habracut />

<p>Давайте сразу определимся, я не являюсь большим поклонником MapReduce, о чем можно было догадаться по предыдущим моим статьям/переводам - <a href="https://habrahabr.ru/post/270017/">Майкл Стоунбрейкер — "Hadoop на распутье"</a> и <a href="https://habrahabr.ru/post/267697/">"Утилиты командной строки могут быть в 235-раз быстрее вашего Hadoop кластера"</a> [Если быть точнее, я не являюсь поклонником Java реализаций Hadoop MapReduce, но это уже личное]</p>

<p>В-любом случае, несмотря на все эти оговорки и недостатки, есть еще множество причин, которые заставляют вернуться к этой теме и попытаться реализовать MapReduce в другой среде и на другом языке. Все это мы озвучим позже, но до этого поговорим про BigData…</p>

<h2 id="когда-data-большая-а-когда-маленькая">Когда Data большая, а когда маленькая?</h2>

<p>Несколько лет назад все стали сходить с ума по BigData, никто правда не знал когда его маленькие данные становятся большими, и где тот предел, но все понимали что это модно, молодёжно и «так» надо делать. Время шло, кое-кто объявил, что BigData уже не buzzword (это довольно таки забавно, но Gartner <a href="http://www.kdnuggets.com/2015/08/gartner-2015-hype-cycle-big-data-is-out-machine-learning-is-in.html">реально убрал</a> волевым решением BigData со своей кривой базвордов за 2016, обосновав это тем, что термин расщепился на другие). Вне зависимости от желания Gartner термин BigData еще среди нас, живее всех живых, и думаю самое время определиться с его пониманием.</p>

<p>Например, понимаем ли мы до конца, когда наши «не очень большие данные» превращаются в «БОЛЬШИЕ ДАННЫЕ»?</p>

<p>Наиболее конкретный (из разумных) ответов дал Дэвид Кантер, один из самых уважаемых экспертов по архитектуре процессоров в целом и x86 в частности1:</p>

<blockquote class="twitter-tweet" data-lang="ru"><p lang="en" dir="ltr">&quot;<a href="https://twitter.com/jrk">@jrk</a>: This: <a href="http://t.co/PSWxSjAbnA">http://t.co/PSWxSjAbnA</a>&quot; data isn&#39;t big until it cannot be held in DRAM on a 2S server. Today that is &gt;3TB <a href="https://twitter.com/hashtag/bigdata?src=hash">#bigdata</a> <a href="https://twitter.com/hashtag/myths?src=hash">#myths</a></p>&mdash; David Kanter (@TheKanter) <a href="https://twitter.com/TheKanter/status/559034352474914816">24 января 2015 г.</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<p><em>FWIW, когда я, работая в Интеле, перешел в аппаратную команду, работающую над «процессором следующего поколения» (don'task), то я начал с изучения материалов про <a href="http://www.realworldtech.com/nehalem/">архитектуру процессора</a> <a href="http://www.realworldtech.com/nehalem/">Nehalem</a> на сайте Дэвида Кантера, а не с внутренних доков HAS и MAS. Потому как у Дэвида было лучше, и понятнее.</em></p>

<p>Т.е. если у вас «всего пара терабайт» данных, то вы, скорее всего, сможете найти аппаратную конфигурацию серверной машины, достаточную для того, чтобы все данные поместились в памяти сервера (при достаточном, конечно, количестве денег и мотивации), и ваши данные еще не совсем Большие.</p>

<p>BigData начинаются когда такой подход с вертикальным масштабированием (нахождением «более лучшей» машины) перестают работать, т.к. с определенного размера данных вы уже не можете купить большей конфигурации, ни за какие (разумные) деньги. И надо начинать расти вширь.</p>

<h2 id="проще--лучше">Проще – лучше</h2>

<p>Ок, определившись с какого размера у нас данные выросли до термина BigData, мы должны определиться с подходами, которые работают на больших данных. Одним из первых подходов, который начал массово применяться на больших данных был <a href="https://en.wikipedia.org/wiki/MapReduce">MapReduce</a>. Существует множество альтернативных программных моделей, работающих с большими данными, которые могут даже оказаться лучше или гибче чем MapReduce, но тот, однозначно может считаться самым упрощенным, хотя может быть и не самым эффективным.</p>

<p>Более того, как только мы начинаем рассматривать какую-то программную платформу, или платформу баз данных, на предмет поддержки BigData, мы по умолчанию предполагаем, что MapReduce сценарий поддерживается на этой платформе внутренними или внешними утилитами.</p>

<p><em>Другими словами – без MapReduce ты не можешь утверждать, что твоя платформа поддерживает BigData!</em></p>

<p>ALARM – если вы все же были не на луне последние 10 лет, то можете смело проматывать рассказ про основы алгоритма MapReduce, скорее всего, вы уже в курсе. Для остальных мы попытаемся (еще раз) рассказать про то, с чего это все начиналось, и как этим всем можно воспользоваться в конце 2016 года. (Особенно на платформах, где MapReduce не поддерживается из коробки.)</p>

<p>Часто было замечено, что самый простой подход к решению задачи позволяет получить наилучше результаты, и остаётся жить в продукте на продолжительное время. Вне от оригинального плана авторов. Даже если, в итоге, он не оказывается самым эффективным, но в силу того, что сообщество уже его широко узнало, и все изучили, и он просто достаточно хорош и решает задачи. Примерно такой эффект и наблюдается с моделью MapReduce – будучи очень простым в основе своей, он по-прежнему широко используется даже после того, <a href="http://www.datacenterknowledge.com/archives/2014/06/25/google-dumps-mapreduce-favor-new-hyper-scale-analytics-system/">как оригинальные авторы декларировали его смерть</a>.</p>

<h2 id="масштабирование-в-caché">Масштабирование в Caché</h2>

<p>Исторически InterSystems Caché имел достаточно инструментов в своём арсенале, как для вертикального, так и горизонтального масштабирования. Как мы <em>все</em> знаем (грустный смайл) Caché это не только сервер баз данных, но и сервер приложений, который может использовать ECP (Enterprise Cache Protocol) для горизонтального масштабирования и высокой доступности.</p>

<p>Особенность ECP протокола –  будучи сильно оптимизированным протоколом для когерентности доступа к одним и тем же данным на разных узлах кластера, сильно упирается в производительность write daemon на центральном узле сервера БД. ECP позволяет добавить дополнительные счетные узлы с ядрами процессоров, если нагрузка на write-daemon не очень высокая, но этот протокол не поможет отмасштабировать ваше приложение горизонтально, если каждый из вовлеченных узлов порождает большую активность на запись. Дисковая подсистема на сервере БД по-прежнему будет узким местом.</p>

<p>На самом деле, при работе с большими данными современные приложения предполагают использование другого, или даже ортогонального озвученном выше, подхода. Масштабировать приложение горизонтально надо с использованием дисковой подсистемы на каждом из узлов кластера. В отличие от ECP, где данные приносятся на удаленный узел, мы наоборот, приносим код, размер которого предполагается малым, к данным на каждом узле, размер которых предполагается очень большим (как минимум относительно размера данных). Похожий тип партиционирования, именуемый шардингом, в будущем будет реализован в SQL движке Caché в одном из <em>будущих</em> продуктов. Но даже <em>сегодня</em>, <em>на имеющихся в платформе средствах</em>, мы можем реализовать нечто простое, что позволило бы нам спроектировать горизонтально масштабируемую систему, с применением современных, «модных, молодежных» подходов. Например, с применением MapReduce…</p>

<h2 id="google-mapreduce">Google MapReduce</h2>

<p>Оригинальная реализация MapReduce была написана в <a href="http://static.googleusercontent.com/media/research.google.com/ru/archive/mapreduce-osdi04.pdf">Google на Си++</a>, но так получилось, что широкое распространение парадигмы началось в индустрии только с реализации MapReduce от Apache, которая на Java. В-любом случае, вне зависимости от языка реализации, идея остается одной и той же, будь та реализована на C++, Java, Go, или Caché ObjectScript, как в нашем случае.</p>

<p>[Хотя, для Caché ObjectScript реализации мы воспользуемся парой трюков, доступных только при операциях с многомерными массивами, известными как <a href="http://docs.intersystems.com/latest/csp/docbook/DocBook.UI.Page.cls?KEY=GGBL_structure">глобалы</a>. Просто, потому что можем]</p>

<p><img src="https://habrastorage.org/files/56e/cc4/174/56ecc41743d0499f8f52272190f98af3.png" align="center" />
Рисунок 1. Исполнениевсреде MapReduce изстатьи <a href="http://static.googleusercontent.com/media/research.google.com/ru/archive/mapreduce-osdi04.pdf">"MapReduce: Simplified Data Processing on Large Clusters", OSDI-2004</a></p>

<p>Давайте пройдемся по стадиям алгоритма MapReduce, нарисованного в картинке выше:</p>

<ol>
  <li>
    <p>На входе у нас есть набор «файлов», или потенциально бесконечный поток данных, который мы можем разбить (партиционировать) на несколько независимых кусков данных;</p>
  </li>
  <li>
    <p>Также имеем набор параллельных исполнителей (локальных внутри узла или может быть удаленных, на других узлах кластера) которые мы можем назначить как обработчиков входных кусков данных (стадия «отображение» /« <strong>map</strong> »)</p>
  </li>
  <li>
    <p>Эти параллельные обработчики читают входной поток данных и выводят в выходной поток пару(ы) «ключ-значение». Выходной поток может быть записан в выходные файлы или куда-то еще (например, в кластерную файловую систему Google GFS, Apache HDFS, или в какое другое «волшебное место» реплицирующее данные на несколько узлов кластера);</p>
  </li>
  <li>
    <p>На следующей стадии, именуемой «свертка» / « <strong>reduce</strong> » у нас имеется другой набор обработчиков, которые занимаются (сюрприз) … сверткой. Они читают, для заданного ключа, всю коллекцию данных, и выводят результирующие данные как очередные «ключ-значения». Выходной поток этой стадии, аналогично предыдущей стадии, записывается в волшебные кластерные файловые системы или их аналоги.</p>
  </li>
</ol>

<p>Заметим, что MapReduce подход – пакетный по своей природе. Он не очень хорошо обрабатывает бесконечные потоки входных данных, в силу пакетной реализации, и будет ожидать завершения работы на каждой из его стадий («отображение» или «свертка»), перед тем как продвинуться дальше в конвейере. Этим он отличается от более современных поточных алгоритмов, используемых, например, в Apache Kafka, которые по своему дизайну нацелены на обработку «бесконечных» входных потоков.</p>

<p>Знающие люди пропустили данный раздел, а незнающие, думаю, по-прежнему смущены. Давайте рассмотрим классический пример word-count (подсчет слов в потоке данных), который по традиции используется при объяснении реализации MapReduce на разных языках программирования, и в разных средах.</p>

<p>Итак, допустим, нам надо подсчитать количество слов во входной коллекции (достаточно большой) файлов. Для ясности определимся, что словом будем считать последовательность символом между пробельными символами, т.е. цифры, знаки пунктуации также посчитаются частью слова, это, конечно, не очень хорошо, но в рамках простого примера это нас не волнует.</p>

<p>Будучи Си++ разработчиком в глубинах своей души, для меня алгоритм становится ясен, когда я вижу пример на Си++. Если «Вы - не такой», то не расстраивайтесь, скоро мы его покажем в упрощенном виде.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">#include "mapreduce/mapreduce.h"
</span>
<span class="c1">// User's map function</span>
<span class="k">class</span> <span class="nc">WordCounter</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Mapper</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">Map</span><span class="p">(</span><span class="k">const</span> <span class="n">MapInput</span><span class="o">&amp;</span> <span class="n">input</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">text</span> <span class="o">=</span> <span class="n">input</span><span class="p">.</span><span class="n">value</span><span class="p">();</span>
        <span class="k">const</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Skip past leading whitespace</span>
            <span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">isspace</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="n">i</span><span class="o">++</span><span class="p">;</span>
            <span class="c1">// Find word end</span>
            <span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isspace</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="n">i</span><span class="o">++</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">Emit</span><span class="p">(</span><span class="n">text</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="n">start</span><span class="p">),</span><span class="s">"1"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="n">REGISTER_MAPPER</span><span class="p">(</span><span class="n">WordCounter</span><span class="p">);</span>
 
<span class="c1">// User's reduce function</span>
<span class="k">class</span> <span class="nc">Adder</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Reducer</span> <span class="p">{</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">Reduce</span><span class="p">(</span><span class="n">ReduceInput</span><span class="o">*</span> <span class="n">input</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Iterate over all entries with the</span>
        <span class="c1">// same key and add the values</span>
        <span class="n">int64</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">value</span> <span class="o">+=</span> <span class="n">StringToInt</span><span class="p">(</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">());</span>
            <span class="n">input</span><span class="o">-&gt;</span><span class="n">NextValue</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="c1">// Emit sum for input-&gt;key()</span>
        <span class="n">Emit</span><span class="p">(</span><span class="n">IntToString</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="n">REGISTER_REDUCER</span><span class="p">(</span><span class="n">Adder</span><span class="p">);</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ParseCommandLineFlags</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
    <span class="n">MapReduceSpecification</span> <span class="n">spec</span><span class="p">;</span>
 
    <span class="c1">// Store list of input files into "spec"</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">MapReduceInput</span><span class="o">*</span> <span class="n">input</span> <span class="o">=</span> <span class="n">spec</span><span class="p">.</span><span class="n">add_input</span><span class="p">();</span>
        <span class="n">input</span><span class="o">-&gt;</span><span class="n">set_format</span><span class="p">(</span><span class="s">"text"</span><span class="p">);</span>
        <span class="n">input</span><span class="o">-&gt;</span><span class="n">set_filepattern</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="n">input</span><span class="o">-&gt;</span><span class="n">set_mapper_class</span><span class="p">(</span><span class="s">"WordCounter"</span><span class="p">);</span>
    <span class="p">}</span>
 
    <span class="c1">// Specify the output files:</span>
    <span class="c1">// /gfs/test/freq-00000-of-00100</span>
    <span class="c1">// /gfs/test/freq-00001-of-00100</span>
    <span class="c1">// ...</span>
    <span class="n">MapReduceOutput</span><span class="o">*</span> <span class="n">out</span> <span class="o">=</span> <span class="n">spec</span><span class="p">.</span><span class="n">output</span><span class="p">();</span>
    <span class="n">out</span><span class="o">-&gt;</span><span class="n">set_filebase</span><span class="p">(</span><span class="s">"/gfs/test/freq"</span><span class="p">);</span>
    <span class="n">out</span><span class="o">-&gt;</span><span class="n">set_num_tasks</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
    <span class="n">out</span><span class="o">-&gt;</span><span class="n">set_format</span><span class="p">(</span><span class="s">"text"</span><span class="p">);</span>
    <span class="n">out</span><span class="o">-&gt;</span><span class="n">set_reducer_class</span><span class="p">(</span><span class="s">"Adder"</span><span class="p">);</span>
 
    <span class="c1">// Optional: do partial sums within map</span>
    <span class="c1">// tasks to save network bandwidth</span>
    <span class="n">out</span><span class="o">-&gt;</span><span class="n">set_combiner_class</span><span class="p">(</span><span class="s">"Adder"</span><span class="p">);</span>
 
    <span class="c1">// Tuning parameters: use at most 2000</span>
    <span class="c1">// machines and 100 MB of memory per task</span>
    <span class="n">spec</span><span class="p">.</span><span class="n">set_machines</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
    <span class="n">spec</span><span class="p">.</span><span class="n">set_map_megabytes</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
    <span class="n">spec</span><span class="p">.</span><span class="n">set_reduce_megabytes</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
 
    <span class="c1">// Now run it</span>
    <span class="n">MapReduceResult</span> <span class="n">result</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MapReduce</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">))</span> <span class="n">abort</span><span class="p">();</span>
    <span class="c1">// Done: 'result' structure contains info</span>
    <span class="c1">// about counters, time taken, number of</span>
    <span class="c1">// machines used, etc.</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>
    <p>Программа, приведенная выше, вызывается со списком файлов, которые надо обработать, переданным через стандартные argc/argv.</p>
  </li>
  <li>
    <p>Объект MapReduceInput инстанциируется как обертка для доступа к каждому файлу из входного списка и планируется на исполнение классом WordCount для обработки его данных;</p>
  </li>
  <li>
    <p>MapReduceOutput инстанциируется с перенаправлением выходных данных в кластерную файловую систему GoogleGFS (обратите внимание на /gfs/test/*)</p>
  </li>
  <li>
    <p>Классы Reducer (свёртщик, хмм) и Combiner (комбинатор) реализуются Си++ классом Adder, текст которого приводится в этой же программе;</p>
  </li>
  <li>
    <p>Функция Map в классе Mapper, реализованная в нашем случае в классе WordCouner, получает данные через обобщенный интерфейс MapInput.  Нашем случае этот интерфейс будет поставлять данные из файлов. Класс, реализующий данный интерфейс, должен реализовать метод value(), поставляющий следующую строку как string, и длину входных данных в методе size();</p>
  </li>
  <li>
    <p>В рамках решения нашего задания, подсчета количества слов в файле, мы будем игнорировать пробельные символы и считать все остальное, между пробелами как отдельное слово (вне зависимости от знаков пунктуации). Найденное слово пишем в выходной «поток» через вызов функции Emit(word, "1");</p>
  </li>
  <li>
    <p>Функция Reduce в классе реализации интерфейса Reducer (в нашем случае это Adder) получает свои входные данные через другой обобщенный интерфейс ReduceInput. Данная функция будет вызвана для определенного ключа (слова из файла, в нашем случае) из пары «ключ-значение», записанных на предыдущей стадии Map. Эта функция будет вызвана для обработки коллекции значений, советующих данному ключу (в нашем случае для последовательности «1»). В рамках нашего задания, ответственность функции Reducer - подсчитать количество таких единиц на входе и выдача суммарного числа в выходной канал.</p>
  </li>
  <li>
    <p>Если у нас построен кластер из нескольких узлов, или просто запускается множество обработчиков в рамках алгоритма MapReduce, то ответственностью «мастера» будет разбить поток выдаваемых пар «ключ-значение» на соответствующие коллекции, и перенаправление этих коллекций на вход Reduce обработчикам.</p>
  </li>
</ul>

<p>Детали реализации такого мастер узла будут сильно зависеть от протокола реализации используемой технологии кластеризации, т.ч. мы опустим подробный рассказ об этом за скобками текущего повествования. В нашем случае, для Caché ObjectScript, для некоторых рассматриваемых алгоритмов (как текущий WordCount) мастер может быть реализован тривиально, в силу использования глобалов и их природы, как отсортированных, но разреженных массивов. О чем подробнее позже.</p>

<ul>
  <li>В общем случае, часто необходимо завести несколько шагов Reduce, например, для случаев, когда невозможно обработать полную коллекцию значений за один заход. И тогда появляется дополнительная(ые) стадия(ии) Combiner, которые будут дополнительно агрегировать результаты данных с предыдущих стадий Reduce.</li>
</ul>

<p>Если, после такого подробного описания Си++ реализации, вам по-прежнему непонятно что такое MapReduce, то давайте попробуем изобразить этот алгоритм на нескольких строках одного известного скриптового языка:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">map</span><span class="p">(</span><span class="n">String</span> <span class="n">key</span><span class="p">,</span> <span class="n">String</span> <span class="n">value</span><span class="p">):</span>
   <span class="o">//</span> <span class="n">key</span><span class="p">:</span> <span class="n">document</span> <span class="n">name</span>
   <span class="o">//</span> <span class="n">value</span><span class="p">:</span> <span class="n">document</span> <span class="n">contents</span>
   <span class="k">for</span> <span class="n">each</span> <span class="n">word</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
      <span class="n">EmitIntermediate</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="s">"1"</span><span class="p">);</span>

<span class="nb">reduce</span><span class="p">(</span><span class="n">String</span> <span class="n">key</span><span class="p">,</span> <span class="n">Iterator</span> <span class="n">values</span><span class="p">):</span>
   <span class="o">//</span> <span class="n">key</span><span class="p">:</span> <span class="n">a</span> <span class="n">word</span>
   <span class="o">//</span> <span class="n">values</span><span class="p">:</span> <span class="n">a</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">counts</span>
   <span class="nb">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">for</span> <span class="n">each</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
      <span class="n">result</span> <span class="o">+=</span> <span class="n">ParseInt</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
   <span class="n">Emit</span><span class="p">(</span><span class="n">AsString</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
</code></pre></div></div>

<p>Как в этом упрощенном примере видим, ответственностью функции map будет выдать последовательность пар &lt;ключ, значение&gt;. Эти пары перемешиваются и сортируются в мастере, и результирующие коллекции значений, для заданного ключа, отсылаются на вход функций reduce (свертка), которые, в свою очередь, ответственны за генерацию выходной пары &lt;ключ,значение&gt;. В нашем случае это будет &lt;слово,счетчик&gt;</p>

<p>В классической реализации MapReduce трансформация коллекции пар &lt;ключ,значение&gt; в раздельные коллекции &lt;ключ, значени(я)&gt; является самой время- и ресурсоёмкой операцией. В случае же Caché реализации, как из-за природы реализации хранилищ btree*, так и связующего протокола ECP, сортировка и агрегация на мастере становятся не такой большой задачей, реализуемой почти на автомате, почти «забесплатно». Об этом мы расскажем при случае в следующих статьях.</p>

<p><em>Пожалуй, этого достаточно для вводной части – мы еще не затронули собственно Caché ObjectScript реализации, хотя и дали достаточно информации для начала реализации MapReduce на любом языке. К нашей реализации MapReduce мы вернемся в следующей статье. Оставайтесь на линии!</em></p>

				<hr />
				<footer class="page-footer">
					

<div class="author-image">
    <img src="http://tsafin.net/images/tsafin_twitter_small_logo.jpg" alt="Timur Safin">
</div>
<!-- ./author-image -->
<div class="author-content">
    <h3 class="author-name">Written by <span itemprop="author">Timur Safin</span></h3>
    <p class="author-bio"></p>
</div>
<!-- ./author-content -->
					<div class="inline-btn">
	<a class="btn-social twitter" href="https://twitter.com/intent/tweet?text=Какая-такая%20Data?%20или%20Еще%20раз%20про%20MapReduce&amp;url=http://tsafin.net/blog/mapreduce/mapreduce-russian-part-i/&amp;via=tsafin" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i> Share on Twitter</a>
	<a class="btn-social facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://tsafin.net/blog/mapreduce/mapreduce-russian-part-i/" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i> Share on Facebook</a>
	<a class="btn-social google-plus"  href="https://plus.google.com/share?url=http://tsafin.net/blog/mapreduce/mapreduce-russian-part-i/" target="_blank"><i class="fa fa-google-plus" aria-hidden="true"></i> Share on Google+</a>
</div><!-- /.share-this -->

					<div class="page-meta">
	<p>Updated <time datetime="2016-09-26T14:07:00Z" itemprop="datePublished">September 26, 2016</time></p>
</div><!-- /.page-meta -->
				</footer><!-- /.footer -->
				<aside>
					<hr />
<div id="disqus_thread"></div>
<script type="text/javascript">
	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
	var disqus_shortname = 'tsafin-net';

	/* * * DON'T EDIT BELOW THIS LINE * * */
	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

				</aside>
			</div><!-- /.content -->
		</div><!-- /.inner-wrap -->
		
	</article><!-- ./wrap -->
</div><!-- /#main -->

      <footer role="contentinfo" id="site-footer">
	<nav role="navigation" class="menu bottom-menu">
		<ul class="menu-item">
		
      
			<li><a href="http://tsafin.net/" >Home</a></li>
		
      
			<li><a href="http://tsafin.net/blog/" >Articles</a></li>
		
      
			<li><a href="http://tsafin.net/projects/" >Projects</a></li>
		
      
			<li><a href="http://tsafin.net/about/" >About</a></li>
		
		</ul>
	</nav><!-- /.bottom-menu -->
	<p class="copyright">&#169; 2020 <a href="http://tsafin.net">Timur Safin - Making No Sense</a> powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> + <a href="http://mmistakes.github.io/skinny-bones-jekyll/" rel="nofollow">Skinny Bones</a>.</p>
</footer>

    </div>

    <script src="http://tsafin.net/js/vendor/jquery-1.9.1.min.js"></script>
    <script src="http://tsafin.net/js/main.js"></script>

    

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-84704404-1', 'auto');
  ga('require', 'linkid');
  ga('send', 'pageview');

</script>


<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter40768979 = new Ya.Metrika({
                    id:40768979,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true
                });
            } catch(e) { }
        });

        var n = d.getElementsByTagName("script")[0],
            s = d.createElement("script"),
            f = function () { n.parentNode.insertBefore(s, n); };
        s.type = "text/javascript";
        s.async = true;
        s.src = "https://mc.yandex.ru/metrika/watch.js";

        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else { f(); }
    })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/40768979" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->



  </body>

</html>
